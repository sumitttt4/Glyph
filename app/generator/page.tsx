"use client";

import { useState, useCallback } from 'react';
import { Sidebar } from '@/components/generator/Sidebar';
import { Toolbar } from '@/components/generator/Toolbar';
import { LoadingState } from '@/components/generator/LoadingState';
import { WorkbenchBentoGrid } from '@/components/generator/WorkbenchBentoGrid';
import { useBrandGenerator } from '@/hooks/use-brand-generator';

export default function GeneratorPage() {
    const { brand, generateBrand, isGenerating, resetBrand } = useBrandGenerator();
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [selectedVibe, setSelectedVibe] = useState('minimalist');
    const [viewMode, setViewMode] = useState<'overview' | 'presentation'>('overview');

    const handleGenerate = useCallback((prompt: string, vibe: string, name: string) => {
        // For now, we use the vibe-based generation
        // Future: Pass prompt to Groq API for AI-enhanced generation
        generateBrand(vibe, name);
    }, [generateBrand]);

    const handleExport = (type: string) => {
        if (!brand) return;

        if (type === 'svg') {
            // Export SVG logo
            const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${brand.shape.viewBox || "0 0 24 24"}">
        <path d="${brand.shape.path}" fill="${brand.theme.tokens.light.primary}" />
      </svg>`;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${brand.name.toLowerCase().replace(/\s+/g, '-')}-logo.svg`;
            link.click();
        } else if (type === 'tailwind') {
            // Export Tailwind config
            const tokens = brand.theme.tokens;
            const config = `// ${brand.name} - Tailwind CSS Config
// Generated by Glyph

module.exports = {
  theme: {
    extend: {
      colors: {
        // Light Mode
        light: {
          background: "${tokens.light.bg}",
          foreground: "${tokens.light.text}",
          primary: "${tokens.light.primary}",
          surface: "${tokens.light.surface}",
          muted: "${tokens.light.muted}",
          border: "${tokens.light.border}",
        },
        // Dark Mode
        dark: {
          background: "${tokens.dark.bg}",
          foreground: "${tokens.dark.text}",
          primary: "${tokens.dark.primary}",
          surface: "${tokens.dark.surface}",
          muted: "${tokens.dark.muted}",
          border: "${tokens.dark.border}",
        },
      },
    },
  },
};`;
            navigator.clipboard.writeText(config);
            alert('Tailwind config copied to clipboard!');
        } else if (type === 'react') {
            // Export React Component
            const componentCode = `// ${brand.name} Logo Component
// Generated by Glyph

interface LogoProps {
  className?: string;
  color?: string;
}

export function ${brand.name.replace(/\s+/g, '')}Logo({ className = "w-8 h-8", color = "${brand.theme.tokens.light.primary}" }: LogoProps) {
  return (
    <svg
      viewBox="${brand.shape.viewBox || "0 0 24 24"}"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <path d="${brand.shape.path}" fill={color} />
    </svg>
  );
}

// Usage:
// <${brand.name.replace(/\s+/g, '')}Logo className="w-12 h-12" />
// <${brand.name.replace(/\s+/g, '')}Logo color="#000000" />
`;
            navigator.clipboard.writeText(componentCode);
            alert('React component copied to clipboard!');
        } else if (type === 'all') {
            // Export all as alert (in production would generate ZIP)
            alert('Full Package export coming soon! This will include: SVG, PNG (multiple sizes), Tailwind config, React component, and brand guidelines PDF.');
        }
    };

    return (
        <div className="flex h-screen w-full bg-stone-50 overflow-hidden font-sans">
            {/* Loading State Overlay */}
            <LoadingState isLoading={isGenerating} />

            {/* LEFT SIDEBAR */}
            <Sidebar
                onGenerate={handleGenerate}
                isGenerating={isGenerating}
                selectedVibe={selectedVibe}
                setSelectedVibe={setSelectedVibe}
            />

            {/* RIGHT CANVAS */}
            <main className="flex-1 relative bg-[#FAFAF9] overflow-auto">
                {/* Dot Grid Background */}
                <div
                    className="absolute inset-0 opacity-40"
                    style={{
                        backgroundImage: 'radial-gradient(#A8A29E 1px, transparent 1px)',
                        backgroundSize: '24px 24px',
                    }}
                />

                {/* Toolbar */}
                <div className="absolute top-6 right-8 z-30">
                    <Toolbar
                        isDark={isDarkMode}
                        toggleDark={() => setIsDarkMode(!isDarkMode)}
                        onExport={handleExport}
                        viewMode={viewMode}
                        setViewMode={setViewMode}
                    />
                </div>

                {/* Content Area */}
                <div className={`relative z-10 transition-all duration-500 w-full min-h-full pt-20 pb-20 ${isDarkMode ? 'dark' : ''}`}>
                    {brand ? (
                        <WorkbenchBentoGrid
                            brand={brand}
                            isDark={isDarkMode}
                            onShuffleLogo={() => generateBrand(selectedVibe, brand.name)}
                            viewMode={viewMode}
                        />

                    ) : (
                        /* Empty State */
                        <div className="text-center max-w-md px-8">
                            <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-stone-200 flex items-center justify-center">
                                <svg viewBox="0 0 24 24" className="w-12 h-12 fill-stone-400">
                                    <path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18s-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18s.41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9z" />
                                </svg>
                            </div>
                            <h2 className="text-xl font-bold text-stone-900 mb-2">No Brand Generated</h2>
                            <p className="text-stone-500 text-sm leading-relaxed">
                                Describe your startup in the sidebar and select a vibe to generate your brand identity system.
                            </p>
                        </div>
                    )}
                </div>

                {/* Back to Home Link */}
                {brand && (
                    <button
                        onClick={resetBrand}
                        className="absolute bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-white border border-stone-200 rounded-full text-sm text-stone-600 hover:border-stone-400 transition-colors shadow-sm"
                    >
                        Generate New Brand
                    </button>
                )}
            </main>
        </div>
    );
}
